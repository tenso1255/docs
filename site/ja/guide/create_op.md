# オペレーションを作成する

Note: あなたのC++のカスタムオペレーションがTensorFlow公式のpipパッケージとABI互換になることを保証するため、[Custom opリポジトリ](https://github.com/tensorflow/custom-op) のガイドに従ってください。
あなたのカスタムオペレーションをビルドし配布するためのDockerのイメージはもちろんのこと、端から端までのコード例が示されています。

既存のTensorFlowのライブラリに存在しないオペレーションを作りたい場合、既存のPythonのオペレーションや関数を組み合わせて、Pythonでオペレーションを書くことを推奨します。
もしそれが不可能なら、C++のカスタムオペレーションを作ってもよいです。
C++のカスタムオペレーションを作りたいと思う理由は、いくつかあります。

* 既存のオペレーションの組み合わせでオペレーションを表現するのが、不可能または簡単ではない
* 既存のプリミティブの組み合わせでオペレーションを表現するのは、効率的ではない
* 将来コンパイラが融合することが難しいプリミティブの組み合わせを、自前で融合したい

例えば、"MaxPool" オペレーションと似ているが、最大値のかわりにウィンドウをスライドさせて中央値を計算する、"median pooling" のようなものを実装したいとしましょう。
これは、オペレーションの組み合わせ（例えば、ExtraImagePatchesとTopKを使う）でも可能ですが、1つの融合したオペレーションとしてより賢明に実装したネイティブなオペレーションと比較して、性能とメモリ効率の面で劣るかもしれません。
オペレーションの組み合わせで、あなたがやりたいことを表現する試みは価値があります。
もしそれが難しいまたは非効率であることが証明されたときのみ、新しいオペレーションを追加することを検討しましょう。

あなたのカスタムオペレーションを組み込むために必要なことを次に示します。

1. C++ファイル内で新しいオペレーションを登録します。オペレーションの登録では、オペレーションの実装とは独立であるオペレーションの機能のためのインターフェース（仕様）を定義します。例えば、オペレーションの登録では、オペレーション名やオペレーションの入出力を定義します。また、テンソルのシェイプ推論に使用されるシェイプ関数を定義します。
2. C++でオペレーションを実装します。オペレーションの実装はカーネルとして知られ、Step 1で登録した仕様の実装を具体化します。異なる入出力型、アーキテクチャ（例えば、CPUやGPU）のために複数のカーネルが存在することもあり得ます。
